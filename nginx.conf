# ========================================
# ğŸš€ Enhanced Nginx Configuration for HLS
# ========================================

user root;
worker_processes auto;
worker_rlimit_nofile 65535;
error_log /app/logs/nginx_error.log warn;
pid /tmp/nginx.pid;

events {
    worker_connections 4096;
    use epoll;
    multi_accept on;
    accept_mutex off;
    worker_aio_requests 32;
}

http {
    # MIME types Ù…Ø­Ø³Ù†Ø©
    # include /etc/nginx/mime.types;
    types {
        application/vnd.apple.mpegurl     m3u8;
        video/mp2t                        ts;
        video/iso.segment                 m4s;
        video/mp4                         mp4;
        application/dash+xml              mpd;
    }
    default_type application/octet-stream;

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                   '$status $body_bytes_sent "$http_referer" '
                   '"$http_user_agent" "$http_x_forwarded_for" '
                   'rt=$request_time uct="$upstream_connect_time" '
                   'uht="$upstream_header_time" urt="$upstream_response_time"';

    access_log /app/logs/nginx_access.log main buffer=16k flush=5s;

    # Ù…Ø³Ø§Ø±Ø§Øª Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    client_body_temp_path /tmp/client_temp;
    proxy_temp_path /tmp/proxy_temp;
    fastcgi_temp_path /tmp/fastcgi_temp;
    uwsgi_temp_path /tmp/uwsgi_temp;
    scgi_temp_path /tmp/scgi_temp;

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ù…Ø­Ø³Ù†Ø©
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 10000;
    reset_timedout_connection on;
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø© Ù…Ø¤Ù‚ØªØ§Ù‹
    client_body_buffer_size 128k;
    client_max_body_size 10m;
    client_header_buffer_size 4k;
    large_client_header_buffers 8 16k;
    client_body_timeout 12;
    client_header_timeout 12;
    send_timeout 10;
    
    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø®Ø±Ø¬Ø§Øª
    output_buffers 2 32k;
    postpone_output 1460;
    
    # Ø¶ØºØ· Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø³Ù†
    gzip on;
    gzip_vary on;
    gzip_min_length 1000;
    gzip_comp_level 6;
    gzip_types
        application/vnd.apple.mpegurl
        application/dash+xml
        application/json
        application/javascript
        text/css
        text/javascript
        text/plain
        text/xml
        application/xml;
    gzip_disable "msie6";
    gzip_proxied any;

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Brotli (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ±Ø§Ù‹)
    # brotli on;
    # brotli_comp_level 6;
    # brotli_types text/plain text/css application/json application/javascript application/vnd.apple.mpegurl;

    # Ø­Ø¯ÙˆØ¯ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ù†Ù‚Ù„ Ù„Ù„Ø­Ù…Ø§ÙŠØ© Ù…Ù† DDoS
    limit_req_zone $binary_remote_addr zone=api:10m rate=30r/m;
    limit_req_zone $binary_remote_addr zone=stream:10m rate=10r/s;
    
    # Ø®Ø±ÙŠØ·Ø© Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ Cache
    map $uri $cache_control {
        ~\.m3u8$    "no-cache, no-store, must-revalidate";
        ~\.ts$      "public, max-age=31536000, immutable";
        ~\.m4s$     "public, max-age=31536000, immutable";
        ~\.mp4$     "public, max-age=31536000, immutable";
        default     "public, max-age=3600";
    }

    # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù…Ø§Ù†
    server_tokens off;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    server {
        listen 5000 default_server;
        server_name _;
        
        # Ù…ØªØºÙŠØ± Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„ - Ù…ØªÙˆØ§ÙÙ‚ Ù…Ø¹ Docker
        root /app;
        
        # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø§Ù…Ø© Ù„Ù„Ø®Ø§Ø¯Ù…
        charset utf-8;
        client_max_body_size 1m;
        
        # HealthCheck Ù„Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©
        location /health {
            access_log off;
            add_header Content-Type text/plain;
            return 200 "OK\n";
        }

        # Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø®Ø§Ø¯Ù…
        location /info {
            add_header Content-Type application/json;
            return 200 '{"status":"running","server":"nginx-hls","version":"2.0"}';
        }

        # Ù…Ø³Ø§Ø± Ù…Ù„ÙØ§Øª Ø§Ù„Ø¨Ø« Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
        location /hls/ {
            alias /app/hls/;
            
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª CORS Ù…Ø­Ø³Ù†Ø©
            add_header Access-Control-Allow-Origin "*" always;
            add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            add_header Access-Control-Allow-Headers "Range, Cache-Control, If-Modified-Since, If-None-Match" always;
            add_header Access-Control-Expose-Headers "Content-Length, Content-Range, Date, ETag, Last-Modified" always;
            add_header Access-Control-Max-Age 86400 always;
            
            # Ø§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø·Ù„Ø¨Ø§Øª OPTIONS
            if ($request_method = 'OPTIONS') {
                add_header Access-Control-Allow-Origin "*";
                add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS";
                add_header Access-Control-Allow-Headers "Range, Cache-Control";
                add_header Access-Control-Max-Age 86400;
                add_header Content-Type text/plain;
                add_header Content-Length 0;
                return 204;
            }
            
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ù„Ø¨Ø«
            sendfile off;
            tcp_nopush off;
            tcp_nodelay on;
            aio threads;
            directio 4m;
            directio_alignment 512;
            
            # ØªØ­ÙƒÙ… ÙÙŠ Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª
            limit_req zone=stream burst=20 nodelay;
            
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Cache Ù…Ø­Ø³Ù†Ø©
            add_header Cache-Control $cache_control always;
            add_header Accept-Ranges bytes always;
            
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ù„Ù…Ù„ÙØ§Øª M3U8
            location ~* \.m3u8$ {
                add_header Cache-Control "no-cache, no-store, must-revalidate" always;
                add_header Pragma "no-cache" always;
                add_header Expires "0" always;
                add_header X-Accel-Buffering "no" always;
                
                # ØªØ­Ø³ÙŠÙ† Ø§Ù„ØªØ³Ù„ÙŠÙ…
                sendfile off;
                tcp_nopush off;
                tcp_nodelay on;
                
                # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª CORS Ù„Ù„Ù€ M3U8
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            }
            
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ù„Ù…Ù„ÙØ§Øª TS Ùˆ M4S
            location ~* \.(ts|m4s)$ {
                add_header Cache-Control "public, max-age=31536000, immutable" always;
                add_header X-Accel-Buffering "no" always;
                
                # ØªØ­Ø³ÙŠÙ† Ø§Ù„Ù†Ù‚Ù„
                sendfile on;
                tcp_nopush on;
                tcp_nodelay off;
                
                # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª CORS Ù„Ù„Ù€ Segments
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            }
            
            # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ù„Ù…Ù„ÙØ§Øª MP4 (Init)
            location ~* \.(mp4|m4v)$ {
                add_header Cache-Control "public, max-age=31536000, immutable" always;
                add_header X-Accel-Buffering "no" always;
                
                # Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª CORS Ù„Ù„Ù€ MP4
                add_header Access-Control-Allow-Origin "*" always;
                add_header Access-Control-Allow-Methods "GET, HEAD, OPTIONS" always;
            }
        }

        # Ù…Ø³Ø§Ø± Ù„Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
        location /stats {
            add_header Content-Type text/plain;
            
            # Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ù…Ø¬Ù„Ø¯ HLS
            access_by_lua_block {
                local handle = io.popen("find /app/hls -name '*.ts' -o -name '*.m4s' | wc -l")
                local segment_count = handle:read("*a")
                handle:close()
                
                ngx.header["Content-Type"] = "application/json"
                ngx.say('{"segments": ' .. segment_count:gsub("\n", "") .. ', "status": "active"}')
            }
        }

        # ØµÙØ­Ø© Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ø³ÙŠØ·Ø© Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…ÙÙŠØ¯Ø©
        location = / {
            add_header Content-Type text/html;
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>HLS Stream Server</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; background: #f5f5f5; }
        .container { background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status { color: #28a745; font-weight: bold; }
        .link { color: #007bff; text-decoration: none; }
        .link:hover { text-decoration: underline; }
        pre { background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ HLS Stream Server</h1>
        <p class="status">âœ… Server is running</p>
        
        <h3>ğŸ“º Stream Links:</h3>
        <ul>
            <li><a href="/hls/playlist.m3u8" class="link">Main Playlist (M3U8)</a></li>
            <li><a href="/hls/master.m3u8" class="link">Master Playlist</a></li>
            <li><a href="/health" class="link">Health Check</a></li>
            <li><a href="/info" class="link">Server Info</a></li>
        </ul>
        
        <h3>ğŸ“Š Usage Example:</h3>
        <pre>ffplay http://your-domain.com/hls/playlist.m3u8</pre>
        <pre>VLC: Network Stream â†’ http://your-domain.com/hls/playlist.m3u8</pre>
    </div>
</body>
</html>';
        }

        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ù…Ø®ØµØµØ©
        error_page 404 /404.html;
        location = /404.html {
            add_header Content-Type text/html;
            return 404 '
<!DOCTYPE html>
<html>
<head><title>404 - Not Found</title></head>
<body style="font-family:Arial,sans-serif;text-align:center;margin-top:100px;">
    <h1>ğŸ” 404 - Stream Not Found</h1>
    <p>The requested stream or file was not found.</p>
    <a href="/" style="color:#007bff;text-decoration:none;">â† Back to Home</a>
</body>
</html>';
        }

        error_page 500 502 503 504 /50x.html;
        location = /50x.html {
            add_header Content-Type text/html;
            return 500 '
<!DOCTYPE html>
<html>
<head><title>Server Error</title></head>
<body style="font-family:Arial,sans-serif;text-align:center;margin-top:100px;">
    <h1>âš ï¸ Server Error</h1>
    <p>The streaming server encountered an error.</p>
    <a href="/" style="color:#007bff;text-decoration:none;">â† Back to Home</a>
</body>
</html>';
        }
    }
        }
